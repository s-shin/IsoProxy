<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">test/isoproxy-spec.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/s-shin/isoproxy.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div data-ice="classWrap">
  <h2>Class</h2>
  <ul>
    
  <li data-ice="classDoc"><span><a href="class/src/isoproxy.js~IsoProxy.html">IsoProxy</a></span></li>
</ul>
</div>










</nav>

<div class="content" data-ice="content"><h1 data-ice="title">test/isoproxy-spec.js</h1>
<pre class="source-code line-number"><code class="prettyprint linenums" data-ice="content">import assert from &quot;power-assert&quot;;
import co from &quot;co&quot;;
import IsoProxy from &quot;../lib/isoproxy&quot;;
import jsonrpc from &quot;../lib/jsonrpc&quot;;

const interfaces = {
  &quot;*&quot;: [&quot;hello&quot;],
  math: [&quot;add&quot;]
};

const implementations = {
  &quot;*&quot;: {
    hello(name) {
      return new Promise((resolve) =&gt; {
        setTimeout(() =&gt; resolve(`hello ${name}`), 1);
      });
    }
  },
  math: {
    add: (x, y) =&gt; x + y
  }
};

describe(&quot;IsoProxy&quot;, () =&gt; {

  let proxy = null;

  describe(&quot;server&quot;, () =&gt; {

    beforeEach(() =&gt; {
      proxy = new IsoProxy({root: &quot;/api&quot;, isServer: true});
    });

    it(&quot;Basic workflow with #setInterfaces(), #setImplementaions(), and .api&quot;, (done) =&gt; {
      // no api
      assert(!proxy.api[&quot;*&quot;]);
      // register interfaces
      proxy.setInterfaces(interfaces);
      assert(proxy.api[&quot;*&quot;]);
      assert(proxy.api[&quot;*&quot;].hello);
      // but not implemented
      assert.throws(() =&gt; {
        proxy.api[&quot;*&quot;].hello(&quot;world&quot;);
      });
      // register implementations
      proxy.setImplementations(implementations);
      // now implemented
      assert.doesNotThrow(() =&gt; {
        proxy.api[&quot;*&quot;].hello(&quot;world&quot;);
      });
      // return value is just a Promise.
      proxy.api[&quot;*&quot;].hello(&quot;world&quot;).then((result) =&gt; {
        assert(result === &quot;hello world&quot;);
        // with co
        co(function *() {
          let result = yield proxy.api.math.add(1, 2);
          assert(result === 3);
          done();
        });
      });
    });

    it(&quot;traverse .routes&quot;, () =&gt; {
      proxy.setInterfaces(interfaces);
      proxy.setImplementations(implementations);
      let count = 0;
      for (let urlPath in proxy.routes) {
        count++;
        assert([&quot;/api/*&quot;, &quot;/api/math&quot;].indexOf(urlPath) !== -1);
        let processJsonrpcRequest = proxy.routes[urlPath];
        assert(processJsonrpcRequest);
      }
      assert(count === 2);
    });

    it(&quot;match path with .routes&quot;, (done) =&gt; {
      proxy.setInterfaces(interfaces);
      proxy.setImplementations(implementations);
      const processJsonrpcRequest = proxy.routes[&quot;/api/math&quot;];
      assert(processJsonrpcRequest);
      co(function *() {
        var body = jsonrpc.createRequest(&quot;add&quot;, [1, 2]);
        var answer = jsonrpc.createResponse(null, 3);
        const result = yield processJsonrpcRequest(body);
        assert.deepEqual(answer, result);
        done();
      });
    });

  });

});
</code></pre>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.1.1)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
</body>
</html>
